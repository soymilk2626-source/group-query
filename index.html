<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>HXH 獵人揪團</title>

<style>
    *,
*::before,
*::after{
  box-sizing: border-box;
}

body{
margin:0;
min-height:100vh;

.hidden{ display:none; }

.admin-box{
      overflow:hidden;
margin-top:22px;
padding:18px 16px;
background:rgba(255,255,255,.08);
border-radius:14px;
}

.admin-box input{
width:100%;
padding:12px;
border-radius:10px;
border:none;
margin-bottom:12px;
font-size:14px;
}
</style>
</head>

<body>
<div class="box">
<h1>HXH 獵人揪團</h1>

<div class="quote">
我知道你又敗家了，<br>
我也是。
</div>

<div class="question">
——你是豆漿嗎？
</div>

<!-- 初始選擇 -->
<div id="choice">
<button class="btn btn-main" onclick="enterAdmin()">
是，我就是豆漿
</button>
<button class="btn btn-sub" onclick="enterUser()">
不是，我來查團務
</button>
</div>

<!-- 管理者驗證區 -->
<div id="admin" class="hidden">
<div class="admin-box">
<div style="margin-bottom:10px;font-size:14px;">
管理者驗證
</div>
<input id="a_key" type="password" placeholder="請輸入管理碼">
<button class="btn btn-admin" onclick="adminEnter()">進入管理頁</button>
<div id="a_status" style="margin-top:8px;font-size:13px;opacity:.85;"></div>

<!-- 一般查詢頁 -->
<div id="userPage" class="hidden">
  <div class="admin-box">
    <div style="margin-bottom:10px;font-size:14px;">一般查詢</div>

    <input id="u_name" placeholder="暱稱（FB / LINE 名稱）">
    <input id="u_key" placeholder="查詢密碼">

    <button class="btn btn-admin" onclick="userQuery()">查詢</button>
    <div id="u_status" style="margin-top:8px;font-size:13px;opacity:.85;"></div>

    <div id="u_summary" style="margin-top:10px; display:none;">
      <div style="display:flex;gap:10px;flex-wrap:wrap;">
        <div style="padding:8px 10px;border:1px solid rgba(255,255,255,.15);border-radius:999px;">應收：<b id="u_due"></b></div>
        <div style="padding:8px 10px;border:1px solid rgba(255,255,255,.15);border-radius:999px;">已收：<b id="u_paid"></b></div>
        <div style="padding:8px 10px;border:1px solid rgba(255,255,255,.15);border-radius:999px;">差額：<b id="u_bal"></b></div>
      </div>
    </div>

    <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
      <button class="btn btn-sub" onclick="switchUserTab('orders')">訂單明細</button>
      <button class="btn btn-sub" onclick="switchUserTab('payments')">付款明細</button>
    </div>

    <div id="u_list" style="margin-top:10px;"></div>
  </div>

  <button class="btn-escape" onclick="backToChoice()">返回首頁</button>
</div>

<!-- 管理頁 -->
<div id="adminPage" class="hidden">
  <div class="admin-box">
    <div style="margin-bottom:10px;font-size:14px;">管理頁</div>

    <select id="a_group" style="width:100%;margin-bottom:10px;"></select>
    <input id="a_nick" placeholder="搜尋暱稱（可空）">

    <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
      <button class="btn btn-sub" onclick="setAdminOnly('all')">全部</button>
      <button class="btn btn-sub" onclick="setAdminOnly('arrived')">未全到</button>
      <button class="btn btn-sub" onclick="setAdminOnly('unboxed')">未包</button>
      <button class="btn btn-sub" onclick="setAdminOnly('unshipped')">未出</button>
    </div>

    <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
      <button class="btn btn-sub" onclick="selectAll()">全選</button>
      <button class="btn btn-sub" onclick="clearSel()">清空勾選</button>
    </div>

    <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
      <button class="btn btn-admin" onclick="adminOp('arrived_full')">到貨=全到</button>
      <input id="a_arrivedSet" placeholder="手填到貨 qty（例1）" style="min-width:140px;flex:0;">
      <button class="btn btn-sub" onclick="applyArrived()">套用到貨</button>
    </div>

    <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
      <button class="btn btn-admin" onclick="adminOp('make_package')">建立包裹</button>
      <button class="btn btn-admin" onclick="adminOp('mark_packed')">標記已包</button>
      <button class="btn btn-admin" onclick="adminOp('mark_shipped')">標記已出</button>
    </div>

    <div style="margin-top:10px;">
      <input id="a_tracking" placeholder="追蹤單號（批次套用，可空）">
      <button class="btn btn-sub" style="margin-top:8px;" onclick="setTracking()">套用單號</button>
    </div>

    <div style="margin-top:10px;">
      <input id="a_orderLink" placeholder="賣貨便/訂單連結（批次套用，可空）">
      <button class="btn btn-sub" style="margin-top:8px;" onclick="setOrderLink()">套用連結</button>
    </div>

    <div id="a2_status" style="margin-top:10px;font-size:13px;opacity:.85;"></div>
    <div id="a_list" style="margin-top:10px;"></div>
  </div>

  <button class="btn-escape" onclick="adminLogout()">返回首頁</button>
</div>

</div>

<button class="btn-escape" onclick="backToUser()">
我點錯了，其實我不是豆漿
</button>
</div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzwEAj6nG_MdvHoMWJ_KrggB17o15xiIgWyo-zosvLLbrHb87Fabs6leAb9CIQJ6soS/exec";

let adminOnly = "all";
let adminList = [];
let selected = new Set();
let groupsCache = [];
let userTab = "orders";
let userData = null;

function hideAll(){
  ["choice","admin","userPage","adminPage"].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.classList.add("hidden");
  });
}

function backToChoice(){
  hideAll();
  document.getElementById("choice").classList.remove("hidden");
}

function enterAdmin(){
  hideAll();
  document.getElementById("admin").classList.remove("hidden");
  document.getElementById("a_status").textContent = "";
}

function enterUser(){
  hideAll();
  document.getElementById("userPage").classList.remove("hidden");
  document.getElementById("u_status").textContent = "";
}

function backToUser(){
  // 你原本那顆「我點錯了」按鈕
  backToChoice();
}

function adminLogout(){
  document.getElementById("a_key").value = "";
  document.getElementById("a_list").innerHTML = "";
  document.getElementById("a2_status").textContent = "";
  backToChoice();
}

async function safeJson(res){
  const t = await res.text();
  try{ return { ok:true, json: JSON.parse(t) }; }
  catch(e){ return { ok:false, raw:t }; }
}

/** 管理者進入：驗證成功後顯示管理頁 */
async function adminEnter(){
  const key = document.getElementById("a_key").value.trim();
  if(!key){
    document.getElementById("a_status").textContent = "請輸入管理碼。";
    return;
  }
  document.getElementById("a_status").textContent = "驗證中…";
  const ok = await loadAdminList(true);
  if(ok){
    hideAll();
    document.getElementById("adminPage").classList.remove("hidden");
  }
}

/** 讀管理清單 */
async function loadAdminList(isLogin=false){
  const admin_key = document.getElementById("a_key").value.trim();
  const group = document.getElementById("a_group").value || "";
  const nickname = document.getElementById("a_nick").value.trim();

  const onlyMap = { all:"", arrived:"arrived", unboxed:"unboxed", unshipped:"unshipped" };
  const only = onlyMap[adminOnly] || "";

  document.getElementById("a2_status").textContent = "載入中…";
  try{
    const url = `${API_URL}?action=admin_list&admin_key=${encodeURIComponent(admin_key)}&group=${encodeURIComponent(group)}&nickname=${encodeURIComponent(nickname)}&only=${encodeURIComponent(only)}`;
    const res = await fetch(url);
    const parsed = await safeJson(res);
    if(!parsed.ok){
      document.getElementById("a2_status").textContent = "API 回傳不是 JSON（權限/錯誤頁）";
      return false;
    }
    const data = parsed.json;
    if(!data.ok){
      if(isLogin) document.getElementById("a_status").textContent = data.message || "管理碼錯誤";
      document.getElementById("a2_status").textContent = data.message || "讀取失敗";
      return false;
    }

    // groups 下拉
    if(!groupsCache.length){
      groupsCache = data.groups || [];
      const sel = document.getElementById("a_group");
      sel.innerHTML = `<option value="">全部團別</option>` + groupsCache.map(g=>`<option value="${g}">${g}</option>`).join("");
      sel.onchange = ()=>loadAdminList();
    }

    document.getElementById("a_nick").onkeydown = (e)=>{ if(e.key==="Enter") loadAdminList(); };

    adminList = data.list || [];
    selected.clear();
    renderAdminTable();
    document.getElementById("a2_status").textContent = `共 ${adminList.length} 筆（已勾 ${selected.size}）`;
    return true;

  }catch(err){
    console.error(err);
    document.getElementById("a2_status").textContent = "載入失敗（網路或 API）";
    return false;
  }
}

function setAdminOnly(v){
  adminOnly = v;
  loadAdminList();
}

function selectAll(){
  adminList.forEach(x=> selected.add(x.row_key));
  renderAdminTable();
}
function clearSel(){
  selected.clear();
  renderAdminTable();
}
function getSelectedKeys(){ return Array.from(selected); }

async function adminOp(op){
  await adminUpdate(op, {});
}
async function applyArrived(){
  const v = document.getElementById("a_arrivedSet").value.trim();
  if(v==="" || isNaN(Number(v))){
    document.getElementById("a2_status").textContent = "手填到貨 qty 要輸入數字。";
    return;
  }
  await adminUpdate("arrived_set", { value: Number(v) });
}
async function setTracking(){
  const v = document.getElementById("a_tracking").value.trim();
  await adminUpdate("set_tracking", { tracking_no: v });
}
async function setOrderLink(){
  const v = document.getElementById("a_orderLink").value.trim();
  await adminUpdate("set_order_link", { order_link: v });
}

/** ✅ 用 GET 做 admin_update（避免 POST CORS） */
async function adminUpdate(op, payload){
  const admin_key = document.getElementById("a_key").value.trim();
  const row_keys = getSelectedKeys();
  if(!row_keys.length){
    document.getElementById("a2_status").textContent = "請先勾選至少一筆。";
    return;
  }

  document.getElementById("a2_status").textContent = "更新中…";

  const params = new URLSearchParams();
  params.set("action","admin_update");
  params.set("admin_key", admin_key);
  params.set("op", op);
  params.set("row_keys", JSON.stringify(row_keys));
  if(payload.value !== undefined) params.set("value", String(payload.value));
  if(payload.tracking_no !== undefined) params.set("tracking_no", payload.tracking_no);
  if(payload.order_link !== undefined) params.set("order_link", payload.order_link);

  const url = `${API_URL}?${params.toString()}`;

  const res = await fetch(url);
  const parsed = await safeJson(res);
  if(!parsed.ok){
    document.getElementById("a2_status").textContent = "更新失敗（API 回傳不是 JSON）";
    return;
  }
  const data = parsed.json;
  if(!data.ok){
    document.getElementById("a2_status").textContent = data.message || "更新失敗";
    return;
  }
  document.getElementById("a2_status").textContent = data.package_id ? `已建立包裹：${data.package_id}` : "更新完成";
  await loadAdminList();
}

function renderAdminTable(){
  const box = document.getElementById("a_list");
  if(!adminList.length){
    box.innerHTML = `<div style="font-size:13px;opacity:.8;">沒有資料。</div>`;
    return;
  }

  let html = `
  <table>
    <thead>
      <tr>
        <th class="center">選</th>
        <th>團別</th>
        <th>暱稱</th>
        <th>品項</th>
        <th class="center">qty</th>
        <th class="center">到貨</th>
        <th>包裹</th>
      </tr>
    </thead>
    <tbody>
  `;

  adminList.forEach(d=>{
    const checked = selected.has(d.row_key) ? "checked" : "";
    const qty = Number(d.qty||0);
    const aq  = Number(d.arrived_qty||0);

    html += `
      <tr>
        <td class="center"><input type="checkbox" data-rk="${d.row_key}" ${checked}></td>
        <td class="small">${d.group||""}</td>
        <td>${d.nickname||""}</td>
        <td>${d.item||""}</td>
        <td class="center">${qty}</td>
        <td class="center">${aq}/${qty}</td>
        <td class="small">${d.package_id||""}</td>
      </tr>
    `;
  });

  html += `</tbody></table>`;
  box.innerHTML = html;

  box.querySelectorAll("input[type=checkbox][data-rk]").forEach(cb=>{
    cb.onchange = ()=>{
      const rk = cb.getAttribute("data-rk");
      if(cb.checked) selected.add(rk);
      else selected.delete(rk);
      document.getElementById("a2_status").textContent = `共 ${adminList.length} 筆（已勾 ${selected.size}）`;
    };
  });
}

/** 一般查詢 */
async function userQuery(){
  const name = document.getElementById("u_name").value.trim();
  const key  = document.getElementById("u_key").value.trim();
  if(!name || !key){
    document.getElementById("u_status").textContent = "請輸入暱稱與密碼。";
    return;
  }
  document.getElementById("u_status").textContent = "查詢中…";
  document.getElementById("u_list").innerHTML = "";
  document.getElementById("u_summary").style.display = "none";

  const url = `${API_URL}?action=query&q=${encodeURIComponent(name)}&key=${encodeURIComponent(key)}`;
  const res = await fetch(url);
  const parsed = await safeJson(res);
  if(!parsed.ok){
    document.getElementById("u_status").textContent = "API 回傳不是 JSON（權限/錯誤頁）";
    return;
  }
  const data = parsed.json;
  if(!data.ok){
    document.getElementById("u_status").textContent = data.message || "查詢失敗";
    return;
  }

  userData = data;
  document.getElementById("u_due").textContent  = fmt(data.due_total);
  document.getElementById("u_paid").textContent = fmt(data.paid_total);
  document.getElementById("u_bal").textContent  = fmt(data.balance);
  document.getElementById("u_summary").style.display = "";

  document.getElementById("u_status").textContent = `查到 ${data.details.length} 筆訂單、${(data.payments||[]).length} 筆付款。`;
  renderUser();
}

function switchUserTab(t){
  userTab = t;
  renderUser();
}

function fmt(n){ return Number(n||0).toLocaleString("zh-Hant-TW"); }

function renderUser(){
  const box = document.getElementById("u_list");
  if(!userData){ box.innerHTML=""; return; }

  if(userTab === "payments"){
    const pays = userData.payments || [];
    if(!pays.length){
      box.innerHTML = `<div style="font-size:13px;opacity:.8;">沒有付款紀錄。</div>`;
      return;
    }
    let html = `
      <table>
        <thead><tr><th>時間</th><th class="right">金額</th><th>備註</th></tr></thead>
        <tbody>
    `;
    pays.forEach(p=>{
      html += `<tr><td>${p.paid_at||""}</td><td class="right">${fmt(p.amount)}</td><td class="small">${p.note||""}</td></tr>`;
    });
    html += `</tbody></table>`;
    box.innerHTML = html;
    return;
  }

  const list = userData.details || [];
  if(!list.length){
    box.innerHTML = `<div style="font-size:13px;opacity:.8;">沒有訂單資料。</div>`;
    return;
  }

  list.sort((a,b)=> String(a.group||"").localeCompare(String(b.group||""), "zh-Hant"));

  let html = `
    <table>
      <thead>
        <tr>
          <th>品項</th>
          <th class="center">數量</th>
          <th>團別</th>
          <th class="right">金額</th>
        </tr>
      </thead>
      <tbody>
  `;

  list.forEach(d=>{
    html += `
      <tr>
        <td>${d.item||""}</td>
        <td class="center">${d.qty||""}</td>
        <td class="small">${d.group||""}</td>
        <td class="right">${fmt(d.amount)}</td>
      </tr>
    `;
  });

  html += `</tbody></table>`;
  box.innerHTML = html;
}

// 預設回到首頁顯示 choice
backToChoice();
</script>
</body>
</html>
