<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HXHçµäººæªåœ˜</title>
  <style>
    :root{
      --navy:#1f2a44;
      --yellow:#f5c451;
      --bg:#fafafa;
      --line:#e6e6e6;
      --paid:#2e7d32;
      --unpaid:#c62828;
    }
    body{ margin:0; background:var(--bg);
      font-family:-apple-system,BlinkMacSystemFont,"PingFang TC","Microsoft JhengHei",sans-serif; color:#222; }
    .wrap{ max-width:980px; margin:0 auto; padding:18px 14px 70px; }
    /* æ·±è—æ¨™é¡Œæ¢ï¼ˆæ‰‹æ©Ÿä¹Ÿä¸€è¡Œï¼‰ */
    .hero{
      background:var(--navy);
      color:#fff;
      border-radius:18px;
      padding:16px 16px;
      display:flex; flex-direction:column; gap:8px;
    }
    .hero h1{
      margin:0;
      font-size:20px;
      line-height:1.2;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis; /* æ‰‹æ©Ÿä¸€è¡Œ */
    }
    .hero .sub{ font-size:13px; opacity:.9; line-height:1.6; }
    .card{ background:#fff; border:1px solid var(--line); border-radius:16px; padding:14px; margin-top:14px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    input, select{
      padding:12px 12px; border:1px solid var(--line); border-radius:12px; font-size:15px; background:#fff;
      flex:1; min-width:220px;
    }
    button{
      padding:12px 16px; border:0; border-radius:12px; cursor:pointer;
      background:var(--navy); color:#fff; font-size:15px;
      display:inline-flex; align-items:center; gap:10px;
    }
    button.secondary{ background:#fff; color:#222; border:1px solid var(--line); }
    button:disabled{ opacity:.6; cursor:not-allowed; }
    .muted{ color:#777; font-size:12px; }
    .statusline{ margin-top:8px; color:#666; font-size:13px; min-height:18px; }
    .tabs{ display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; }
    .tab{
      padding:7px 12px; border-radius:999px; font-size:13px; border:1px solid var(--line); background:#fff; cursor:pointer; user-select:none;
    }
    .tab.active{ background:var(--yellow); border-color:var(--yellow); font-weight:800; }
    .summary{ display:flex; gap:10px; flex-wrap:wrap; margin:12px 0 6px; }
    .sum{ background:#fff; border:1px solid var(--line); border-radius:999px; padding:10px 12px; font-size:13px; }
    .sum b{ font-size:14px; }

    table{ width:100%; border-collapse:collapse; background:#fff; border:1px solid var(--line); border-radius:16px; overflow:hidden; margin-top:10px; }
    thead{ background:#f1f3f6; }
    th, td{ padding:12px 10px; text-align:left; border-bottom:1px solid var(--line); font-size:14px; vertical-align:top; }
    th{ color:var(--navy); font-size:13px; }
    tr:last-child td{ border-bottom:none; }
    .right{ text-align:right; }
    .center{ text-align:center; }
    .status-badge{
      display:inline-flex; align-items:center; justify-content:center; white-space:nowrap;
      padding:6px 10px; border-radius:999px; font-size:13px; line-height:1; min-width:56px; font-weight:800;
    }
    .paid{ background:#e8f5e9; color:var(--paid); }
    .unpaid{ background:#ffebee; color:var(--unpaid); }

    .spinner{
      width:16px;height:16px;border:2px solid rgba(255,255,255,.45);border-top-color:#fff;border-radius:50%;
      animation:spin .8s linear infinite; display:none;
    }
    .loading .spinner{ display:inline-block; }
    @keyframes spin{ to{ transform:rotate(360deg); } }

    .pill{
      display:inline-flex; gap:8px; align-items:center;
      border:1px solid var(--line); background:#fff; border-radius:999px; padding:10px 12px; font-size:13px;
    }
    .danger{ color:#a40000; }
    .ok{ color:#0b6b2d; }

    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center; padding:18px; z-index:50;
    }
    .modal{
      width:min(520px, 100%); background:#fff; border-radius:18px; padding:16px; border:1px solid var(--line);
    }
    .modal h2{ margin:0 0 8px; font-size:18px; color:var(--navy); }
    .modal .btns{ display:flex; gap:10px; margin-top:12px; flex-wrap:wrap; }
    .hide{ display:none !important; }

    /* æ‰‹æ©Ÿï¼šä¸è¦è—åœ˜åˆ¥ï¼Œæ”¹æˆè—é‡‘é¡æ¬„æœƒæ›´å¥½çœ‹ï¼ˆä½ æƒ³å†èª¿ä¹Ÿå¯ï¼‰ */
    @media(max-width:720px){
      th:nth-child(4), td:nth-child(4){ display:none; } /* é‡‘é¡è—æ‰ï¼ˆç®¡ç†é /æŸ¥è©¢é éƒ½èƒ½ä¿æŒåœ˜åˆ¥ï¼‰ */
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <h1>HXHçµäººæªåœ˜ï¼Œä¸€èµ·ä¾†æ•—å®¶ï¼ï¼</h1>
      <div class="sub">
        ä¸»è¦åœ¨ LINE æ´»å‹•ï¼Œæœ‰ç¾è²¨æ‰æœƒåœ¨å…¶ä»–åœ°æ–¹ç™¼å¸ƒã€‚<br>
        ï¼ˆå°ï¼Œé€™é é¢æœ‰é»æœ‰ç—…ï¼Œä½†å¾ˆå¥½ç”¨ã€‚ï¼‰
      </div>
    </div>

    <!-- Landing -->
    <div class="card" id="landing">
      <div style="font-size:16px; font-weight:900; color:var(--navy);">å…ˆå•ä¸€å¥â€”â€”ä½ æ˜¯è±†æ¼¿å—ï¼Ÿ</div>
      <div class="muted" style="margin-top:6px;">æ˜¯çš„è©±èµ°ç®¡ç†è€…å…¥å£ï¼ˆéœ€è¦ç®¡ç†ç¢¼ï¼‰ï¼›ä¸æ˜¯å°±èµ°ä¸€èˆ¬æŸ¥è©¢ã€‚</div>
      <div class="row" style="margin-top:12px;">
        <button id="btnSoy">ğŸ«˜ æ˜¯ï¼Œæˆ‘æ˜¯è±†æ¼¿</button>
        <button class="secondary" id="btnUser">ğŸ’ ä¸æ˜¯ï¼Œæˆ‘ä¾†æŸ¥åœ˜å‹™</button>
      </div>
    </div>

    <!-- User page -->
    <div class="card hide" id="userPage">
      <div style="font-size:16px; font-weight:900; color:var(--navy);">ä¸€èˆ¬æŸ¥è©¢</div>
      <div class="row" style="margin-top:10px;">
        <input id="u_name" placeholder="æš±ç¨±ï¼ˆFB / LINE åç¨±ï¼‰">
        <input id="u_key" placeholder="æŸ¥è©¢å¯†ç¢¼">
        <button id="u_go"><span class="spinner"></span><span>æŸ¥è©¢</span></button>
      </div>
      <div class="statusline" id="u_status"></div>

      <div class="summary" id="u_summary" style="display:none;">
        <div class="sum">æ‡‰æ”¶ï¼š<b id="u_due"></b></div>
        <div class="sum">å·²æ”¶ï¼š<b id="u_paid"></b></div>
        <div class="sum">å·®é¡ï¼š<b id="u_bal"></b></div>
      </div>

      <div class="tabs">
        <div class="tab active" data-ut="orders">è¨‚å–®æ˜ç´°</div>
        <div class="tab" data-ut="payments">ä»˜æ¬¾æ˜ç´°</div>
      </div>

      <div id="u_list"></div>
    </div>

    <!-- Admin login -->
    <div class="card hide" id="adminLogin">
      <div style="font-size:16px; font-weight:900; color:var(--navy);">ç®¡ç†è€…å…¥å£</div>
      <div class="muted" style="margin-top:6px;">è¼¸å…¥ç®¡ç†ç¢¼ï¼Œä¸ç„¶å°±å›å»ç•¶ä¸€èˆ¬äººã€‚</div>
      <div class="row" style="margin-top:10px;">
        <input id="a_key" placeholder="ç®¡ç†ç¢¼">
        <button id="a_enter">é€²å…¥ç®¡ç†é </button>
        <button class="secondary" id="a_back">è¿”å›</button>
      </div>
      <div class="statusline" id="a_status"></div>
    </div>

    <!-- Admin page -->
    <div class="card hide" id="adminPage">
      <div class="row" style="justify-content:space-between;">
        <div style="font-size:16px; font-weight:900; color:var(--navy);">ç®¡ç†é ï¼ˆæ¯ç­†å“é …ä¸€åˆ—ï¼‰</div>
        <button class="secondary" id="a_logout">ç™»å‡º</button>
      </div>

      <div class="row" style="margin-top:10px;">
        <select id="a_group"></select>
        <input id="a_nick" placeholder="æœå°‹æš±ç¨±ï¼ˆå¯ç©ºï¼‰">
      </div>

      <div class="tabs">
        <div class="tab active" data-at="all">å…¨éƒ¨</div>
        <div class="tab" data-at="arrived">æœªå…¨åˆ°</div>
        <div class="tab" data-at="unboxed">æœªåŒ…</div>
        <div class="tab" data-at="unshipped">æœªå‡º</div>
      </div>

      <div class="row" style="margin-top:10px;">
        <button class="secondary" id="a_selectAll">å…¨é¸ï¼ˆç›®å‰æ¸…å–®ï¼‰</button>
        <button class="secondary" id="a_clearSel">æ¸…ç©ºå‹¾é¸</button>
      </div>

      <div class="row" style="margin-top:10px;">
        <button id="a_arrivedFull">åˆ°è²¨=å…¨åˆ°ï¼ˆarrived=qtyï¼‰</button>
        <div class="pill">
          <span>æ‰‹å¡«åˆ°è²¨ qtyï¼š</span>
          <input id="a_arrivedSet" style="min-width:120px; max-width:160px; flex:0;" placeholder="ä¾‹å¦‚ 1">
          <button class="secondary" id="a_applyArrived">å¥—ç”¨åˆ°è²¨</button>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <button id="a_makePkg">å»ºç«‹åŒ…è£¹ï¼ˆé¸å–åˆ—å…±ç”¨ä¸€å€‹åŒ…è£¹è™Ÿï¼‰</button>
        <button id="a_markPacked">æ¨™è¨˜å·²åŒ…ï¼ˆè‡ªå‹•æ™‚é–“ï¼‰</button>
        <button id="a_markShipped">æ¨™è¨˜å·²å‡ºï¼ˆè‡ªå‹•æ™‚é–“ï¼‰</button>
      </div>

      <div class="row" style="margin-top:10px;">
        <input id="a_tracking" placeholder="è¿½è¹¤å–®è™Ÿï¼ˆå¯ç©ºï¼Œæ‰¹æ¬¡å¥—ç”¨ï¼‰">
        <button class="secondary" id="a_setTracking">å¥—ç”¨å–®è™Ÿ</button>
      </div>

      <div class="row" style="margin-top:10px;">
        <input id="a_orderLink" placeholder="è³£è²¨ä¾¿/è¨‚å–®é€£çµï¼ˆå¯ç©ºï¼Œæ‰¹æ¬¡å¥—ç”¨ï¼‰">
        <button class="secondary" id="a_setOrderLink">å¥—ç”¨é€£çµ</button>
      </div>

      <div class="statusline" id="a2_status"></div>
      <div id="a_list"></div>
    </div>
  </div>

<script>
/*** âœ… ä½ è¦æ”¹çš„ 2 å€‹åœ°æ–¹ ***/
const API_URL  = "https://script.google.com/macros/s/AKfycbzwEAj6nG_MdvHoMWJ_KrggB17o15xiIgWyo-zosvLLbrHb87Fabs6leAb9CIQJ6soS/exec";
const ADMIN_KEY = "a-2001626"; // è¦è·Ÿ Apps Script çš„ ADMIN_KEY ä¸€æ¨£ï¼ˆæˆ–ä½ å¯æ”¹æˆè¼¸å…¥å€¼ï¼‰

/*** helpers ***/
const $ = (id)=>document.getElementById(id);
function esc(s){ return String(s??"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }
function fmt(n){ return Number(n||0).toLocaleString("zh-Hant-TW"); }

async function safeJson(res){
  const t = await res.text();
  try { return { ok:true, json: JSON.parse(t) }; }
  catch(e){ return { ok:false, raw:t }; }
}
function setBtnLoading(btn, on){
  btn.disabled = on;
  btn.classList.toggle("loading", on);
}

/*** Landing flow ***/
$("btnSoy").onclick = ()=>{
  $("landing").classList.add("hide");
  $("adminLogin").classList.remove("hide");
};
$("btnUser").onclick = ()=>{
  $("landing").classList.add("hide");
  $("userPage").classList.remove("hide");
};

$("a_back").onclick = ()=>{
  $("adminLogin").classList.add("hide");
  $("landing").classList.remove("hide");
};

$("a_logout").onclick = ()=>{
  $("adminPage").classList.add("hide");
  $("landing").classList.remove("hide");
  $("a_key").value = "";
};

/*** User page ***/
let userTab = "orders";
let userData = null;

document.querySelectorAll(".tab").forEach(t=>{
  t.addEventListener("click", ()=>{
    // user tabs
    if (t.dataset.ut){
      document.querySelectorAll(".tab").forEach(x=>{ if(x.dataset.ut) x.classList.remove("active"); });
      t.classList.add("active");
      userTab = t.dataset.ut;
      renderUser();
    }
  });
});

$("u_go").onclick = async ()=>{
  const name = $("u_name").value.trim();
  const key  = $("u_key").value.trim();
  if(!name || !key){ alert("è«‹è¼¸å…¥æš±ç¨±èˆ‡å¯†ç¢¼"); return; }

  setBtnLoading($("u_go"), true);
  $("u_status").textContent = "æŸ¥è©¢ä¸­â€¦";
  $("u_list").innerHTML = "";
  $("u_summary").style.display = "none";

  try{
    const url = `${API_URL}?action=query&q=${encodeURIComponent(name)}&key=${encodeURIComponent(key)}`;
    const res = await fetch(url);
    const parsed = await safeJson(res);

    if(!parsed.ok){
      $("u_status").textContent = "âŒ API å›å‚³ä¸æ˜¯ JSONï¼ˆæ¬Šé™æˆ–éŒ¯èª¤é ï¼‰";
      $("u_list").innerHTML = `<div class="muted">${esc(parsed.raw.slice(0,400))}</div>`;
      setBtnLoading($("u_go"), false);
      return;
    }

    const data = parsed.json;
    if(!data.ok){
      $("u_status").textContent = "æŸ¥è©¢å¤±æ•—";
      alert(data.message || "æŸ¥è©¢å¤±æ•—");
      setBtnLoading($("u_go"), false);
      return;
    }

    userData = data;
    $("u_due").textContent = fmt(data.due_total);
    $("u_paid").textContent = fmt(data.paid_total);
    $("u_bal").textContent = fmt(data.balance);
    $("u_summary").style.display = "";

    $("u_status").textContent = `âœ… æ‰¾åˆ° ${data.details.length} ç­†è¨‚å–®ï¼›ä»˜æ¬¾ ${data.payments.length} ç­†`;
    setBtnLoading($("u_go"), false);
    renderUser();

  }catch(err){
    console.error(err);
    $("u_status").textContent = "âŒ æŸ¥è©¢å¤±æ•—ï¼ˆç¶²è·¯æˆ– APIï¼‰";
    setBtnLoading($("u_go"), false);
  }
};

function renderUser(){
  if(!userData){ $("u_list").innerHTML = ""; return; }

  if(userTab === "payments"){
    const pays = userData.payments || [];
    if(!pays.length){
      $("u_list").innerHTML = `<div class="muted">æ²’æœ‰ä»˜æ¬¾ç´€éŒ„</div>`;
      return;
    }
    let html = `
      <table>
        <thead><tr><th>æ™‚é–“</th><th class="right">é‡‘é¡</th><th>å‚™è¨»</th></tr></thead>
        <tbody>
    `;
    pays.forEach(p=>{
      html += `<tr>
        <td>${esc(p.paid_at||"")}</td>
        <td class="right">${fmt(p.amount)}</td>
        <td class="muted">${esc(p.note||"")}</td>
      </tr>`;
    });
    html += `</tbody></table>`;
    $("u_list").innerHTML = html;
    return;
  }

  const list = userData.details || [];
  if(!list.length){
    $("u_list").innerHTML = `<div class="muted">æ²’æœ‰è¨‚å–®è³‡æ–™</div>`;
    return;
  }

  // ä¾åœ˜åˆ¥æ’åº
  list.sort((a,b)=> String(a.group).localeCompare(String(b.group), "zh-Hant"));

  let html = `
    <table>
      <thead>
        <tr>
          <th>å“é …</th>
          <th class="center">æ•¸é‡</th>
          <th>åœ˜åˆ¥</th>
          <th class="right">é‡‘é¡</th>
          <th class="center">åˆ°è²¨</th>
          <th class="center">åŒ…/å‡º</th>
        </tr>
      </thead>
      <tbody>
  `;

  list.forEach(d=>{
    const qty = Number(d.qty||0);
    const aq  = Number(d.arrived_qty||0);
    const arrivedText = `${aq}/${qty}`;

    const pack = (d.pack_status||"æœªåŒ…") === "å·²åŒ…" ? "å·²åŒ…" : "æœªåŒ…";
    const ship = (d.ship_status||"æœªå‡º") === "å·²å‡º" ? "å·²å‡º" : "æœªå‡º";
    const shipPref = d.ship_pref || "ç­‰é½Š";

    html += `
      <tr>
        <td>${esc(d.item||"")}</td>
        <td class="center">${esc(qty)}</td>
        <td class="muted">${esc(d.group||"")}</td>
        <td class="right">${fmt(d.amount)}</td>
        <td class="center">${esc(arrivedText)}<div class="muted">${esc(shipPref)}</div></td>
        <td class="center">
          <div class="muted">${esc(pack)} ${d.packed_at? "@" + esc(d.packed_at):""}</div>
          <div class="muted">${esc(ship)} ${d.shipped_at? "@" + esc(d.shipped_at):""}</div>
          ${d.tracking_no ? `<div class="muted">å–®è™Ÿï¼š${esc(d.tracking_no)}</div>` : ``}
          ${d.order_link ? `<div class="muted">é€£çµï¼š<a href="${esc(d.order_link)}" target="_blank">é»æˆ‘</a></div>` : ``}
        </td>
      </tr>
    `;
  });

  html += `</tbody></table>`;
  $("u_list").innerHTML = html;
}

/*** Admin flow ***/
let adminOnly = "all";
let adminList = [];
let selected = new Set();
let groupsCache = [];

document.querySelectorAll(".tab").forEach(t=>{
  if(t.dataset.at){
    t.addEventListener("click", ()=>{
      document.querySelectorAll(".tab").forEach(x=>{ if(x.dataset.at) x.classList.remove("active"); });
      t.classList.add("active");
      adminOnly = t.dataset.at;
      loadAdminList();
    });
  }
});

$("a_enter").onclick = async ()=>{
  const key = $("a_key").value.trim();
  if(!key){ alert("è«‹è¼¸å…¥ç®¡ç†ç¢¼"); return; }
  // å…ˆæ¸¬è©¦èƒ½ä¸èƒ½æ‹¿åˆ° list
  $("a_status").textContent = "é©—è­‰ä¸­â€¦";
  const ok = await loadAdminList(true);
  if(ok){
    $("adminLogin").classList.add("hide");
    $("adminPage").classList.remove("hide");
    $("a_status").textContent = "";
  }
};

async function loadAdminList(isLogin=false){
  const admin_key = $("a_key").value.trim();
  if(!admin_key) return false;

  const group = $("a_group").value || "";
  const nickname = $("a_nick").value.trim();

  const onlyMap = { all:"", arrived:"arrived", unboxed:"unboxed", unshipped:"unshipped" };
  const only = onlyMap[adminOnly] || "";

  $("a2_status").textContent = "è¼‰å…¥ä¸­â€¦";
  try{
    const url = `${API_URL}?action=admin_list&admin_key=${encodeURIComponent(admin_key)}&group=${encodeURIComponent(group)}&nickname=${encodeURIComponent(nickname)}&only=${encodeURIComponent(only)}`;
    const res = await fetch(url);
    const parsed = await safeJson(res);
    if(!parsed.ok){
      $("a2_status").textContent = "âŒ API å›å‚³ä¸æ˜¯ JSON";
      return false;
    }
    const data = parsed.json;
    if(!data.ok){
      $("a_status").textContent = "";
      if(isLogin) alert(data.message || "ç®¡ç†ç¢¼éŒ¯èª¤");
      $("a2_status").textContent = "âŒ è®€å–å¤±æ•—ï¼š" + (data.message || "");
      return false;
    }

    // å»º groups ä¸‹æ‹‰
    if (!groupsCache.length){
      groupsCache = data.groups || [];
      const sel = $("a_group");
      sel.innerHTML = `<option value="">å…¨éƒ¨åœ˜åˆ¥</option>` + groupsCache.map(g=>`<option value="${esc(g)}">${esc(g)}</option>`).join("");
    }

    adminList = data.list || [];
    selected.clear();
    renderAdminTable();
    $("a2_status").textContent = `âœ… å…± ${adminList.length} ç­†ï¼ˆå‹¾é¸ ${selected.size}ï¼‰`;
    return true;

  }catch(err){
    console.error(err);
    $("a2_status").textContent = "âŒ è¼‰å…¥å¤±æ•—ï¼ˆç¶²è·¯æˆ– APIï¼‰";
    return false;
  }
}

$("a_group").onchange = ()=> loadAdminList();
$("a_nick").onkeydown = (e)=>{ if(e.key==="Enter") loadAdminList(); };

$("a_selectAll").onclick = ()=>{
  adminList.forEach(x=> selected.add(x.row_key));
  renderAdminTable();
};
$("a_clearSel").onclick = ()=>{
  selected.clear();
  renderAdminTable();
};

function getSelectedKeys(){
  return Array.from(selected);
}

async function adminUpdate(op, payload={}){
  const admin_key = $("a_key").value.trim() || ADMIN_KEY; // ä½ ä¹Ÿå¯ä»¥å›ºå®šå¯«æ­»
  const row_keys = getSelectedKeys();
  if(!row_keys.length){ alert("è«‹å…ˆå‹¾é¸è‡³å°‘ä¸€ç­†"); return; }

  $("a2_status").textContent = "æ›´æ–°ä¸­â€¦";

  const body = Object.assign({ action:"admin_update", admin_key, op, row_keys }, payload);

  const res = await fetch(API_URL, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(body)
  });

  const parsed = await safeJson(res);
  if(!parsed.ok){
    $("a2_status").textContent = "âŒ æ›´æ–°å¤±æ•—ï¼ˆAPI å›å‚³ä¸æ˜¯ JSONï¼‰";
    return;
  }
  const data = parsed.json;
  if(!data.ok){
    $("a2_status").textContent = "âŒ æ›´æ–°å¤±æ•—ï¼š" + (data.message||"");
    alert(data.message||"æ›´æ–°å¤±æ•—");
    return;
  }

  if(data.package_id){
    $("a2_status").textContent = `âœ… å·²å»ºç«‹åŒ…è£¹ï¼š${data.package_id}`;
  }else{
    $("a2_status").textContent = "âœ… æ›´æ–°å®Œæˆ";
  }
  await loadAdminList();
}

$("a_arrivedFull").onclick = ()=> adminUpdate("arrived_full");
$("a_applyArrived").onclick = ()=>{
  const v = $("a_arrivedSet").value.trim();
  if(v==="" || isNaN(Number(v))){ alert("è«‹è¼¸å…¥æ•¸å­—åˆ°è²¨ qty"); return; }
  adminUpdate("arrived_set", { value: Number(v) });
};
$("a_makePkg").onclick = ()=> adminUpdate("make_package");
$("a_markPacked").onclick = ()=> adminUpdate("mark_packed");
$("a_markShipped").onclick = ()=> adminUpdate("mark_shipped");

$("a_setTracking").onclick = ()=>{
  const v = $("a_tracking").value.trim();
  adminUpdate("set_tracking", { tracking_no: v });
};
$("a_setOrderLink").onclick = ()=>{
  const v = $("a_orderLink").value.trim();
  adminUpdate("set_order_link", { order_link: v });
};

function renderAdminTable(){
  $("a2_status").textContent = `å…± ${adminList.length} ç­†ï¼ˆå‹¾é¸ ${selected.size}ï¼‰`;

  if(!adminList.length){
    $("a_list").innerHTML = `<div class="muted">æ²’æœ‰è³‡æ–™</div>`;
    return;
  }

  let html = `
    <table>
      <thead>
        <tr>
          <th class="center">é¸</th>
          <th>åœ˜åˆ¥</th>
          <th>æš±ç¨±</th>
          <th>å“é …</th>
          <th class="center">qty</th>
          <th class="center">åˆ°è²¨</th>
          <th>åŒ…è£¹</th>
          <th class="center">åŒ…/å‡º</th>
          <th>å–®è™Ÿ/é€£çµ</th>
        </tr>
      </thead>
      <tbody>
  `;

  adminList.forEach(d=>{
    const checked = selected.has(d.row_key) ? "checked" : "";
    const qty = Number(d.qty||0);
    const aq  = Number(d.arrived_qty||0);

    html += `
      <tr>
        <td class="center">
          <input type="checkbox" data-rk="${esc(d.row_key)}" ${checked}>
        </td>
        <td class="muted">${esc(d.group||"")}</td>
        <td>${esc(d.nickname||"")}</td>
        <td>${esc(d.item||"")}</td>
        <td class="center">${esc(qty)}</td>
        <td class="center">${esc(aq)}/${esc(qty)}<div class="muted">${esc(d.ship_pref||"ç­‰é½Š")}</div></td>
        <td class="muted">${esc(d.package_id||"")}</td>
        <td class="center">
          <div class="muted">${esc(d.pack_status||"æœªåŒ…")}${d.packed_at? "@" + esc(d.packed_at):""}</div>
          <div class="muted">${esc(d.ship_status||"æœªå‡º")}${d.shipped_at? "@" + esc(d.shipped_at):""}</div>
        </td>
        <td class="muted">
          ${d.tracking_no ? `å–®è™Ÿï¼š${esc(d.tracking_no)}<br>` : ``}
          ${d.order_link ? `<a href="${esc(d.order_link)}" target="_blank">è¨‚å–®é€£çµ</a>` : ``}
        </td>
      </tr>
    `;
  });

  html += `</tbody></table>`;
  $("a_list").innerHTML = html;

  // ç¶ checkbox
  $("a_list").querySelectorAll("input[type=checkbox][data-rk]").forEach(cb=>{
    cb.onchange = ()=>{
      const rk = cb.getAttribute("data-rk");
      if(cb.checked) selected.add(rk);
      else selected.delete(rk);
      $("a2_status").textContent = `å…± ${adminList.length} ç­†ï¼ˆå‹¾é¸ ${selected.size}ï¼‰`;
    };
  });
}
</script>
</body>
</html>
