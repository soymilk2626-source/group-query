<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>代購團務查詢</title>
  <style>
    body{font-family:system-ui;max-width:900px;margin:24px auto;padding:0 14px}
    .row{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
    input{flex:1;min-width:220px;padding:12px;border:1px solid #ccc;border-radius:12px}
    button{padding:12px 16px;border:0;border-radius:12px;cursor:pointer}
    .tabs{display:flex;gap:8px;margin:14px 0;flex-wrap:wrap}
    .tab{padding:8px 12px;border:1px solid #ddd;border-radius:999px;cursor:pointer}
    .tab.active{border-color:#000;font-weight:800}
    .summary{display:flex;gap:10px;flex-wrap:wrap;margin:14px 0}
    .pill{border:1px solid #eee;border-radius:999px;padding:8px 12px}
    .muted{color:#666;font-size:13px}
    .group{margin-top:18px;font-weight:800}
    .card{border:1px solid #eee;border-radius:14px;padding:12px;margin:10px 0}
    .right{float:right}
  </style>
</head>
<body>
  <h2>代購團務查詢</h2>
  <div class="muted">輸入暱稱＋密碼，查所有團明細與總金額</div>

  <div class="row">
    <input id="name" placeholder="暱稱（例如：白酒 / FB:nai）" />
    <input id="key" placeholder="查詢密碼" />
    <button id="go">查詢</button>
  </div>

  <div class="tabs">
    <div class="tab active" data-filter="all">全部</div>
    <div class="tab" data-filter="unpaid">未付款</div>
    <div class="tab" data-filter="paid">已付款</div>
  </div>

  <div id="status" class="muted"></div>

  <div class="summary" id="summary" style="display:none">
    <div class="pill">已付：<b id="paid"></b></div>
    <div class="pill">未付：<b id="unpaid"></b></div>
    <div class="pill">總計：<b id="all"></b></div>
  </div>

  <div id="list"></div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzwEAj6nG_MdvHoMWJ_KrggB17o15xiIgWyo-zosvLLbrHb87Fabs6leAb9CIQJ6soS/exec"; // ⭐ 下一步會教你改這行

let rawDetails = [];
let currentFilter = "all";

document.getElementById("go").addEventListener("click", run);
document.querySelectorAll(".tab").forEach(t=>{
  t.addEventListener("click", ()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    currentFilter = t.dataset.filter;
    render();
  });
});

async function run(){
  const name = document.getElementById("name").value.trim();
  const key = document.getElementById("key").value.trim();
  if(!name){ alert("請輸入暱稱"); return; }
  if(!key){ alert("請輸入密碼"); return; }

  setStatus("查詢中…");
  document.getElementById("summary").style.display = "none";
  document.getElementById("list").innerHTML = "";
  rawDetails = [];

  const url = `${API_URL}?q=${encodeURIComponent(name)}&key=${encodeURIComponent(key)}`;
  const res = await fetch(url);
  const data = await res.json();

  if(!data.ok){
    setStatus("查詢失敗：" + (data.message || ""));
    return;
  }

  rawDetails = data.details || [];
  setStatus(`找到 ${rawDetails.length} 筆紀錄`);
  document.getElementById("paid").textContent = fmt(data.total_paid);
  document.getElementById("unpaid").textContent = fmt(data.total_unpaid);
  document.getElementById("all").textContent = fmt(data.total_all);
  document.getElementById("summary").style.display = "";

  render();
}

function render(){
  const filtered = rawDetails.filter(d=>{
    const isPaid = String(d.pay_status||"").includes("已");
    if(currentFilter==="paid") return isPaid;
    if(currentFilter==="unpaid") return !isPaid;
    return true;
  });
  renderGrouped(filtered);
}

function renderGrouped(details){
  const list = document.getElementById("list");
  if(!details.length){
    list.innerHTML = `<div class="muted">沒有資料</div>`;
    return;
  }

  const keyOf = d => (d.group && d.group.trim()) ? d.group.trim() : (d.sheet||"").trim();
  const groups = new Map();
  details.forEach(d=>{
    const k = keyOf(d) || "（未命名）";
    if(!groups.has(k)) groups.set(k, []);
    groups.get(k).push(d);
  });

  let html = "";
  for(const [k, arr] of groups){
    let sub = 0;
    arr.forEach(d=>sub+=Number(d.amount||0));
    html += `<div class="group">${k}<span class="right muted">小計 ${fmt(sub)}</span></div>`;
    arr.forEach(d=>{
      html += `<div class="card">
        <div><b>${d.item||""}</b> × ${d.qty||""}</div>
        <div class="muted">金額：${fmt(d.amount)}｜${d.pay_status}</div>
      </div>`;
    });
  }
  list.innerHTML = html;
}

function setStatus(t){ document.getElementById("status").textContent=t; }
function fmt(n){ return Number(n||0).toLocaleString("zh-Hant-TW"); }
</script>
</body>
</html>

