<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HXH çµäººæªåœ˜ï½œç®¡ç†</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&family=Noto+Serif+TC:wght@700;900&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="base.css">
  <style>
    :root{
      --navy:#0f1f3a;
      --yellow:#f5c451;
      --soft-red:#c45a5a;
      --badge-green:#e7f3ec;
      --badge-gray:#f1f2f4;
      --badge-text:#2f4f3a;
    }

    body{ background:#fafafa; color:#222; font-family:var(--sans); }
    .wrap{ padding:20px 0 80px; }
    .escape-link{ display:block; text-align:center; margin:10px 0 0; color:var(--soft-red); font-weight:800; text-decoration:underline; }

    .card{ background:#fff; border:1px solid var(--line); padding:16px; margin-top:16px; }
    .card h2{ margin:0 0 10px; font-family:var(--serif); font-size:18px; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .row + .row{ margin-top:10px; }

    input, select{
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:999px;
      font-size:14px;
      font-family:var(--sans);
      background:#fff;
      min-height:40px;
    }

    .btn{
      padding:10px 14px;
      border-radius:999px;
      border:0;
      font-size:14px;
      font-weight:900;
      cursor:pointer;
      font-family:var(--sans);
    }

    .btn-primary{ background:var(--navy); color:#fff; }
    .btn-ghost{ background:#fff; border:1px solid var(--line); color:#222; }
    .btn-yellow{ background:var(--yellow); color:#1b1b1b; }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }

    .status-line{
      margin-top:10px;
      font-size:13px;
      font-weight:700;
    }
    .status-line.error{ color:var(--soft-red); }
    .status-line.success{ color:#2f4f3a; }

    .tabs{
      display:flex;
      justify-content:center;
      gap:8px;
      flex-wrap:wrap;
      margin-top:6px;
    }

    .tab{
      padding:6px 14px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      cursor:pointer;
      font-size:13px;
      font-weight:900;
    }
    .tab.active{
      background:var(--yellow);
      border-color:var(--yellow);
    }

    .table-wrap{
      width:100%;
      overflow-x:visible;
      border-radius:12px;
      margin-top:12px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      background:#fff;
      border:1px solid var(--line);
    }
    th, td{
      padding:10px;
      border-bottom:1px solid #eee;
      font-size:14px;
      text-align:left;
      vertical-align:top;
    }
    th{ background:#f2f3f5; font-weight:900; color:#1f2a44; }
    tr:last-child td{ border-bottom:none; }
    .center{ text-align:center; }
    .right{ text-align:right; }

    .badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      white-space:nowrap;
    }
    .badge.ok{ background:var(--badge-green); color:var(--badge-text); }
    .badge.muted{ background:var(--badge-gray); color:#555; }

    .pill-input{ width:180px; }
    .note{ color:#777; font-size:12px; }
    .panel-hidden{ display:none; }

    .admin-login{
      display:flex;
      gap:12px;
      justify-content:center;
      align-items:center;
      flex-wrap:wrap;
    }
    .admin-login input{
      width:min(360px, 90vw);
      height:44px;
      border-radius:999px;
      padding:0 14px;
    }
    .admin-login button{
      height:44px;
      border-radius:999px;
      padding:0 18px;
    }

    @media (max-width: 767px){
      .table-wrap{ overflow-x:auto; -webkit-overflow-scrolling:touch; }
      table{ min-width:900px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="container">
        <h1>ç®¡ç†è€…å¾Œå°</h1>
        <div class="sub">å‡ºè²¨ / åŒ…è£¹ / åˆ°è²¨ å‹¾é¸ç®¡ç†</div>
      </div>
    </div>
    <a class="escape-link" href="index.html">å…¶å¯¦æˆ‘ä¸æ˜¯è±†æ¼¿</a>

      <div class="tabs" id="quick-tabs">
        <button class="tab active" data-filter="all">å…¨éƒ¨</button>
        <button class="tab" data-filter="not-arrived">æœªå…¨åˆ°</button>
        <button class="tab" data-filter="not-packed">æœªåŒ…</button>
        <button class="tab" data-filter="not-shipped">æœªå‡º</button>
      </div>

      <div class="row" style="margin-top:12px;">
        <button id="select-all" class="btn btn-ghost">å…¨é¸</button>
        <button id="clear-all" class="btn btn-ghost">æ¸…ç©ºå‹¾é¸</button>
        <button id="arrived-all" class="btn btn-yellow">åˆ°è²¨=å…¨åˆ° âœ…</button>
        <input id="arrived-input" type="number" min="0" class="pill-input" placeholder="æ‰‹å¡«åˆ°è²¨ qty" />
        <button id="arrived-apply" class="btn btn-yellow">å¥—ç”¨åˆ°è²¨ qty</button>
      </div>

      <div class="row">
        <button id="package-create" class="btn btn-yellow">å»ºç«‹åŒ…è£¹ ğŸ“¦</button>
        <button id="mark-packed" class="btn btn-yellow">æ¨™è¨˜å·²åŒ… ğŸ“¦</button>
        <button id="mark-shipped" class="btn btn-yellow">æ¨™è¨˜å·²å‡º ğŸšš</button>
      </div>

      <div class="row">
        <input id="tracking-input" class="pill-input" placeholder="å¥—ç”¨å–®è™Ÿ" />
        <button id="tracking-apply" class="btn btn-ghost">å¥—ç”¨å–®è™Ÿ</button>
        <input id="link-input" class="pill-input" placeholder="å¥—ç”¨è¨‚å–®é€£çµ" />
        <button id="link-apply" class="btn btn-ghost">å¥—ç”¨è¨‚å–®é€£çµ</button>

        <select id="ship-pref-input">
          <option value="">å¥—ç”¨å‡ºè²¨åå¥½</option>
          <option value="å…ˆå¯„">å…ˆå¯„</option>
          <option value="ç­‰é½Š">ç­‰é½Š</option>
        </select>
        <button id="ship-pref-apply" class="btn btn-ghost">å¥—ç”¨å‡ºè²¨åå¥½</button>
      </div>

        <div id="panel-status" class="status-line"></div>
        <div id="admin-table"></div>
      </div>
    </div>
  </div>

  <script src="app.js"></script>
  <script>
    let adminKey = "";
    let allRows = [];
    let currentFilter = "all";

    const loginBtn = document.getElementById("login");
    const loginStatus = document.getElementById("login-status");
    const panelStatus = document.getElementById("panel-status");
    const adminPanel = document.getElementById("admin-panel");
    const adminTable = document.getElementById("admin-table");
    const groupFilter = document.getElementById("group-filter");
    const nameFilter = document.getElementById("name-filter");

    loginBtn.addEventListener("click", handleLogin);
    groupFilter.addEventListener("change", applyFilters);
    nameFilter.addEventListener("input", applyFilters);

    document.querySelectorAll("#quick-tabs .tab").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll("#quick-tabs .tab").forEach(t => t.classList.remove("active"));
        btn.classList.add("active");
        currentFilter = btn.dataset.filter;
        applyFilters();
      });
    });

    document.getElementById("select-all").addEventListener("click", () => toggleSelection(true));
    document.getElementById("clear-all").addEventListener("click", () => toggleSelection(false));
    document.getElementById("arrived-all").addEventListener("click", () => batchArrivedAll());
    document.getElementById("arrived-apply").addEventListener("click", () => batchArrivedManual());
    document.getElementById("package-create").addEventListener("click", () => batchPackageCreate());
    document.getElementById("mark-packed").addEventListener("click", () => batchMarkPacked());
    document.getElementById("mark-shipped").addEventListener("click", () => batchMarkShipped());
    document.getElementById("tracking-apply").addEventListener("click", () => batchApplyTracking());
    document.getElementById("link-apply").addEventListener("click", () => batchApplyLink());
    document.getElementById("ship-pref-apply").addEventListener("click", () => batchApplyShipPref());

    async function handleLogin(){
      const key = document.getElementById("admin_key").value.trim();
      if(!key){
        setStatus(loginStatus, "è«‹è¼¸å…¥ç®¡ç†ç¢¼", true);
        return;
      }
      adminKey = key;
      setStatus(loginStatus, "é©—è­‰ä¸­â€¦");
      await loadAdminList();
    }

    async function loadAdminList(){
      const url = `${API_URL}?action=admin_list&admin_key=${encodeURIComponent(adminKey)}`;
      console.log("[admin_list] url", url);
      try{
        const res = await fetch(url);
        const data = await res.json();
        console.log("[admin_list] response", { ok: data.ok, message: data.message });
        if(!data.ok){
          setStatus(loginStatus, data.message || "ç®¡ç†ç¢¼éŒ¯èª¤", true);
          return;
        }
        allRows = data.details || [];
        adminPanel.classList.remove("panel-hidden");
        setStatus(loginStatus, "ç™»å…¥æˆåŠŸ", false, true);
        buildGroupOptions(data.groups);
        applyFilters();
      }catch(err){
        console.error(err);
        setStatus(loginStatus, "ç„¡æ³•é€£ç·šç®¡ç†æ¸…å–®", true);
      }
    }

    function buildGroupOptions(groupsFromApi){
      const groups = groupsFromApi?.length
        ? groupsFromApi
        : Array.from(new Set(allRows.map(row => (row.group || row.sheet || "").trim()).filter(Boolean)));

      groupFilter.innerHTML = `<option value="">å…¨éƒ¨åœ˜åˆ¥</option>` +
        groups.map(g => `<option value="${esc(g)}">${esc(g)}</option>`).join("");
    }

    function applyFilters(){
      const selectedGroup = groupFilter.value;
      const nameQuery = nameFilter.value.trim().toLowerCase();
      let rows = allRows.slice();

      if(selectedGroup){
        rows = rows.filter(row => String(row.group || row.sheet || "").trim() === selectedGroup);
      }
      if(nameQuery){
        rows = rows.filter(row => String(row.name || row.nickname || "").trim().toLowerCase().includes(nameQuery));
      }

      if(currentFilter === "not-arrived"){
        rows = rows.filter(row => Number(row.arrived_qty || 0) < Number(row.qty || 0));
      }
      if(currentFilter === "not-packed"){
        rows = rows.filter(row => normalizeStatus(row.pack_status) !== "å·²åŒ…");
      }
      if(currentFilter === "not-shipped"){
        rows = rows.filter(row => normalizeStatus(row.ship_status) !== "å·²å‡º");
      }

      renderTable(rows);
    }

    function renderTable(rows){
      if(!rows.length){
        adminTable.innerHTML = `<div class="note">ç›®å‰æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è³‡æ–™ã€‚</div>`;
        return;
      }

      let html = `
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th class="center">å‹¾é¸</th>
                <th>åœ˜åˆ¥</th>
                <th>æš±ç¨±</th>
                <th>å“é …</th>
                <th class="center">qty</th>
                <th class="center">arrived/qty</th>
                <th>å‡ºè²¨åå¥½</th>
                <th>åŒ…è£¹ç·¨è™Ÿ</th>
                <th>åŒ…è²¨ç‹€æ…‹</th>
                <th>å‡ºè²¨ç‹€æ…‹</th>
                <th>ç‰©æµå–®è™Ÿ</th>
                <th>è¨‚å–®é€£çµ</th>
                <th>å‚™è¨»</th>
              </tr>
            </thead>
            <tbody>
      `;

      rows.forEach(row => {
        const qty = Number(row.qty || 0);
        const arrived = Number(row.arrived_qty || 0);
        const packStatus = normalizeStatus(row.pack_status) || "æœªåŒ…";
        const shipStatus = normalizeStatus(row.ship_status) || "æœªå‡º";
        const packBadge = buildBadge(packStatus);
        const shipBadge = buildBadge(shipStatus);
        const packedAt = row.packed_at ? ` @${esc(row.packed_at)}` : "";
        const shippedAt = row.shipped_at ? ` @${esc(row.shipped_at)}` : "";
        const orderLink = row.order_link ? `<a href="${esc(row.order_link)}" target="_blank" rel="noopener">è¨‚å–®é€£çµ</a>` : "";

        html += `
          <tr>
            <td class="center"><input type="checkbox" class="row-check" data-row-id="${esc(row.row_id || "")}"></td>
            <td>${esc(row.group || row.sheet || "")}</td>
            <td>${esc(row.name || row.nickname || "")}</td>
            <td>${esc(row.item || "")}</td>
            <td class="center">${esc(qty)}</td>
            <td class="center">${esc(arrived)}/${esc(qty)}</td>
            <td>${esc(row.ship_pref || "")}</td>
            <td>${esc(row.package_id || "")}</td>
            <td>${packBadge} ${packedAt}</td>
            <td>${shipBadge} ${shippedAt}</td>
            <td>${esc(row.tracking_no || "")}</td>
            <td>${orderLink}</td>
            <td>${esc(row.note || "")}</td>
          </tr>
        `;
      });

      html += `</tbody></table></div>`;
      adminTable.innerHTML = html;
    }

    function normalizeStatus(value){
      return String(value || "").trim();
    }

    function buildBadge(statusText){
      const isOk = statusText === "å·²åŒ…" || statusText === "å·²å‡º";
      const className = isOk ? "badge ok" : "badge muted";
      return `<span class="${className}">${esc(statusText)}</span>`;
    }

    function toggleSelection(isChecked){
      document.querySelectorAll(".row-check").forEach(input => {
        input.checked = isChecked;
      });
    }

    function getSelectedRows(){
      const selectedIds = Array.from(document.querySelectorAll(".row-check"))
        .filter(input => input.checked)
        .map(input => input.dataset.rowId)
        .filter(Boolean);
      return allRows.filter(row => selectedIds.includes(row.row_id));
    }

    function formatNow(){
      const d = new Date();
      const pad = n => String(n).padStart(2, "0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    function generatePackageId(){
      const d = new Date();
      const pad = n => String(n).padStart(2, "0");
      const datePart = `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}`;
      const rand = Math.floor(Math.random() * 900) + 100;
      return `P${datePart}-${rand}`;
    }

    async function sendUpdates(updates, successMessage){
      if(!updates.length){
        setStatus(panelStatus, "è«‹å…ˆå‹¾é¸è³‡æ–™", true);
        return;
      }
      const url = `${API_URL}?action=admin_update`;
      console.log("[admin_update] url", url);

      try{
        const res = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ action: "admin_update", admin_key: adminKey, updates })
        });
        const data = await res.json();
        console.log("[admin_update] response", { ok: data.ok, message: data.message });
        if(!data.ok){
          setStatus(panelStatus, data.message || "æ›´æ–°å¤±æ•—", true);
          return;
        }
        setStatus(panelStatus, successMessage || "æ›´æ–°å®Œæˆ", false, true);
        await loadAdminList();
      }catch(err){
        console.error(err);
        setStatus(panelStatus, "ç„¡æ³•æ›´æ–°è³‡æ–™", true);
      }
    }

    function batchArrivedAll(){
      const rows = getSelectedRows();
      const updates = rows.map(row => ({
        row_id: row.row_id,
        patch: { arrived_qty: Number(row.qty || 0) }
      }));
      sendUpdates(updates, "å·²å°‡åˆ°è²¨è¨­ç‚ºå…¨åˆ°");
    }

    function batchArrivedManual(){
      const value = Number(document.getElementById("arrived-input").value);
      if(Number.isNaN(value)){
        setStatus(panelStatus, "è«‹è¼¸å…¥åˆ°è²¨æ•¸é‡", true);
        return;
      }
      const rows = getSelectedRows();
      const updates = rows.map(row => ({
        row_id: row.row_id,
        patch: { arrived_qty: value }
      }));
      sendUpdates(updates, "å·²æ›´æ–°åˆ°è²¨æ•¸é‡");
    }

    function batchPackageCreate(){
      const rows = getSelectedRows();
      const packageId = generatePackageId();
      const updates = rows.map(row => ({
        row_id: row.row_id,
        patch: { package_id: packageId }
      }));
      sendUpdates(updates, `å·²å»ºç«‹åŒ…è£¹ ${packageId}`);
    }

    function batchMarkPacked(){
      const rows = getSelectedRows();
      const now = formatNow();
      const updates = rows.map(row => ({
        row_id: row.row_id,
        patch: { pack_status: "å·²åŒ…", packed_at: now }
      }));
      sendUpdates(updates, "å·²æ¨™è¨˜åŒ…è²¨");
    }

    function batchMarkShipped(){
      const rows = getSelectedRows();
      const now = formatNow();
      const updates = rows.map(row => ({
        row_id: row.row_id,
        patch: { ship_status: "å·²å‡º", shipped_at: now }
      }));
      sendUpdates(updates, "å·²æ¨™è¨˜å‡ºè²¨");
    }

    function batchApplyTracking(){
      const value = document.getElementById("tracking-input").value.trim();
      if(!value){
        setStatus(panelStatus, "è«‹è¼¸å…¥å–®è™Ÿ", true);
        return;
      }
      const rows = getSelectedRows();
      const updates = rows.map(row => ({
        row_id: row.row_id,
        patch: { tracking_no: value }
      }));
      sendUpdates(updates, "å·²å¥—ç”¨å–®è™Ÿ");
    }

    function batchApplyLink(){
      const value = document.getElementById("link-input").value.trim();
      if(!value){
        setStatus(panelStatus, "è«‹è¼¸å…¥è¨‚å–®é€£çµ", true);
        return;
      }
      const rows = getSelectedRows();
      const updates = rows.map(row => ({
        row_id: row.row_id,
        patch: { order_link: value }
      }));
      sendUpdates(updates, "å·²å¥—ç”¨è¨‚å–®é€£çµ");
    }

    function batchApplyShipPref(){
      const value = document.getElementById("ship-pref-input").value;
      if(!value){
        setStatus(panelStatus, "è«‹é¸æ“‡å‡ºè²¨åå¥½", true);
        return;
      }
      const rows = getSelectedRows();
      const updates = rows.map(row => ({
        row_id: row.row_id,
        patch: { ship_pref: value }
      }));
      sendUpdates(updates, "å·²å¥—ç”¨å‡ºè²¨åå¥½");
    }

    function setStatus(target, message, isError, isSuccess){
      target.textContent = message || "";
      target.classList.remove("error", "success");
      if(isError) target.classList.add("error");
      if(isSuccess) target.classList.add("success");
    }
  </script>
</body>
</html>
